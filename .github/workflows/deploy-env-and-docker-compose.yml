# Reference caller workflow for GTMT front. Prepares env file and partial docker-compose,
# then calls reusable workflows from BehindTheMusicTree/github-workflows (deploy-app-env-file,
# deploy-partial-docker-compose). Copy to your GTMT front app repo's .github/workflows/.
# Requires: scripts/generate-docker-compose-part.sh. GitHub var: GTMT_FRONT_APP_NAME (e.g. gtmt-front).
#name: Deploy env variables and partial Docker Compose

on:
  workflow_call:
    inputs:
      app_version:
        description: "App version to use"
        required: true
        type: string
      env:
        description: "Environment to deploy to (test or prod, lowercase)"
        required: true
        type: string

env:
  CONTAINER_ROOT_DIR: /home/app/
  ENV_FILENAME: ${{ vars.GTMT_FRONT_APP_NAME }}.env

jobs:
  prepare:
    name: Prepare artifacts
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check required vars and secrets
        env:
          APP_NAME: ${{ vars.GTMT_FRONT_APP_NAME }}
          APP_PORT: ${{ vars.APP_PORT }}
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
          HTMT_API_SUBDOMAIN_NAME: ${{ vars.HTMT_API_SUBDOMAIN_NAME }}
          API_VERSION: ${{ vars.API_VERSION }}
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          APP_IMAGE_REPO: ${{ vars.APP_IMAGE_REPO }}
          SPOTIFY_REDIRECT_RELATIVE_URI: ${{ vars.SPOTIFY_REDIRECT_RELATIVE_URI }}
          SPOTIFY_SCOPES: ${{ vars.SPOTIFY_SCOPES }}
          GOOGLE_REDIRECT_RELATIVE_URI: ${{ vars.GOOGLE_REDIRECT_RELATIVE_URI }}
          SERVER_DEPLOY_USERNAME: ${{ secrets.SERVER_DEPLOY_USERNAME }}
          SERVER_DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.SERVER_DEPLOY_SSH_PRIVATE_KEY }}
          SPOTIFY_CLIENT_ID_TEST: ${{ secrets.SPOTIFY_CLIENT_ID_TEST }}
          SPOTIFY_CLIENT_ID_PROD: ${{ secrets.SPOTIFY_CLIENT_ID_PROD }}
          GOOGLE_CLIENT_ID_TEST: ${{ vars.GOOGLE_CLIENT_ID_TEST }}
          GOOGLE_CLIENT_ID_PROD: ${{ vars.GOOGLE_CLIENT_ID_PROD }}
        run: |
          MISSING=()
          for name in DOMAIN_NAME APP_NAME APP_PORT CONTACT_EMAIL HTMT_API_SUBDOMAIN_NAME \
            API_VERSION DOCKERHUB_USERNAME \
            APP_IMAGE_REPO SPOTIFY_REDIRECT_RELATIVE_URI SPOTIFY_SCOPES GOOGLE_REDIRECT_RELATIVE_URI \
            SERVER_DEPLOY_USERNAME SERVER_DEPLOY_SSH_PRIVATE_KEY SPOTIFY_CLIENT_ID_TEST SPOTIFY_CLIENT_ID_PROD GOOGLE_CLIENT_ID_TEST GOOGLE_CLIENT_ID_PROD; do
            eval "val=\$$name"
            if [ -z "$val" ]; then MISSING+=("$name"); fi
          done
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "Missing required vars or secrets: ${MISSING[*]}"
            exit 1
          fi
          echo "All required vars and secrets are set."

      - name: Set env lowercase
        id: env-lower
        run: echo "env_lower=$(echo "${{ inputs.env }}" | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build nginx env fragment
        run: |
          mkdir -p nginx_fragment
          {
            echo "GTMT_FRONT_PORT=${{ vars.APP_PORT }}"
          } > nginx_fragment/${{ vars.APP_PORT }}.env

      - name: Upload nginx-env-fragment artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-env-fragment
          path: nginx_fragment/

      - name: Build compose env file
        run: |
          mkdir -p pool_compose
          ARTIFACT_FILENAME="${ENV_FILENAME#.}"
          {
            echo "APP_VERSION=${{ inputs.app_version }}"
            echo "APP_PORT=${{ vars.APP_PORT }}"
            echo "NEXT_PUBLIC_APP_VERSION=${{ inputs.app_version }}"
            echo "NEXT_PUBLIC_CONTACT_EMAIL=${{ vars.CONTACT_EMAIL }}"
            echo "NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ steps.env-lower.outputs.env_lower == 'prod' && vars.HTMT_API_SUBDOMAIN_NAME || format('{0}-{1}', vars.HTMT_API_SUBDOMAIN_NAME, steps.env-lower.outputs.env_lower) }}.${{ vars.DOMAIN_NAME }}/${{ vars.API_VERSION }}/"
            echo "NEXT_PUBLIC_SENTRY_IS_ACTIVE=${{ vars.SENTRY_IS_ACTIVE }}"
            echo "NEXT_PUBLIC_SPOTIFY_AUTH_URL=https://accounts.spotify.com/authorize"
            echo "NEXT_PUBLIC_SPOTIFY_CLIENT_ID=${{ steps.env-lower.outputs.env_lower == 'test' && secrets.SPOTIFY_CLIENT_ID_TEST || secrets.SPOTIFY_CLIENT_ID_PROD }}"
            echo "NEXT_PUBLIC_SPOTIFY_REDIRECT_URI=/${{ vars.SPOTIFY_REDIRECT_RELATIVE_URI }}"
            echo "NEXT_PUBLIC_SPOTIFY_SCOPES=${{ vars.SPOTIFY_SCOPES }}"
            echo "NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ steps.env-lower.outputs.env_lower == 'test' && vars.GOOGLE_CLIENT_ID_TEST || vars.GOOGLE_CLIENT_ID_PROD }}"
            echo "NEXT_PUBLIC_GOOGLE_REDIRECT_URI=/${{ vars.GOOGLE_REDIRECT_RELATIVE_URI }}"
          } > "pool_compose/${ARTIFACT_FILENAME}"

      - name: Generate docker compose part file
        env:
          DOCKER_COMPOSE_PART_FILENAME: ${{ vars.GTMT_FRONT_APP_NAME }}.yml
          SERVICE_NAME: ${{ vars.GTMT_FRONT_APP_NAME }}
          PROJECT_DIR: ${{ env.CONTAINER_ROOT_DIR }}
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          IMAGE_REPO: ${{ vars.APP_IMAGE_REPO }}
          APP_VERSION: ${{ inputs.app_version }}
          CONTAINER_NAME: ${{ vars.GTMT_FRONT_APP_NAME }}-${{ steps.env-lower.outputs.env_lower }}
          APP_PORT: ${{ vars.APP_PORT }}
          ENV_FILENAME: ${{ env.ENV_FILENAME }}
        run: bash scripts/generate-docker-compose-part.sh

      - name: Prepare compose-parts
        run: |
          mkdir -p compose_parts
          cp scripts/${{ vars.GTMT_FRONT_APP_NAME }}.yml compose_parts/

      - name: Upload app-env-files artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-env-files
          path: pool_compose/

      - name: Upload compose-parts artifact
        uses: actions/upload-artifact@v4
        with:
          name: compose-parts
          path: compose_parts/

  deploy-nginx-env:
    name: Deploy nginx env fragment
    needs: [prepare]
    uses: BehindTheMusicTree/github-workflows/.github/workflows/deploy-nginx-env-fragment.yml@main
    with:
      env: ${{ inputs.env }}
      app_name: ${{ vars.GTMT_FRONT_APP_NAME }}
    secrets: inherit

  deploy-app-env-files:
    name: Deploy app env file
    needs: [prepare]
    uses: BehindTheMusicTree/github-workflows/.github/workflows/deploy-app-env-file.yml@main
    with:
      env: ${{ inputs.env }}
      app_name: ${{ vars.GTMT_FRONT_APP_NAME }}
      artifact_name: app-env-files
    secrets: inherit

  deploy-compose:
    name: Deploy partial docker compose
    needs: [prepare]
    uses: BehindTheMusicTree/github-workflows/.github/workflows/deploy-docker-compose-part.yml@main
    with:
      env: ${{ inputs.env }}
      app_version: ${{ inputs.app_version }}
    secrets: inherit
