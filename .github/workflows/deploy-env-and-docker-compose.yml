# Reusable deploy workflow for GTMT front. Deploys app env file to pool/compose/<APP_NAME>/
# and partial docker-compose to the compose dir. Same pattern as API deploy-env-and-docker-compose.
# Copy to front repo as .github/workflows/deploy-env-and-docker-compose.yml
# Requires: scripts/check-workflow-env.sh, scripts/generate-partial-docker-compose.sh (see API repo).
# Requires GitHub var: APP_NAME (e.g. gtmt-front) for pool path.
name: Deploy env variables and partial Docker Compose

on:
  workflow_call:
    inputs:
      app_version:
        description: "App version to use"
        required: true
        type: string
      env:
        description: "Environment to deploy to (test or prod)"
        required: true
        type: string

env:
  SSH_DESTINATION: ${{ secrets.SERVER_DEPLOY_USERNAME }}@${{ vars.DOMAIN_NAME }}
  CONTAINER_ROOT_DIR: /home/app/
  DOCKERIZED_APP_ENV_FILENAME: .env_gtmt_front

jobs:
  prepare:
    name: Prepare artifacts
    runs-on: ubuntu-latest
    environment:
      name: TEST
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check required vars and secrets
        env:
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          WEBHOOK_DIR: ${{ vars.WEBHOOK_DIR }}
          WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE: ${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE }}
          DOCKER_COMPOSE_DIR_NAME: ${{ vars.DOCKER_COMPOSE_DIR_NAME }}
          APP_NAME: ${{ vars.APP_NAME }}
          GTMT_FRONT_SERVICE_NAME: ${{ vars.GTMT_FRONT_SERVICE_NAME }}
          GTMT_FRONT_PORT: ${{ vars.GTMT_FRONT_PORT }}
          CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
          HTMT_API_SUBDOMAIN_NAME: ${{ vars.HTMT_API_SUBDOMAIN_NAME }}
          API_VERSION: ${{ vars.API_VERSION }}
          CONTAINER_NAME: ${{ vars.CONTAINER_NAME }}
          DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE: ${{ vars.DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE }}
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          GTMT_FRONT_IMAGE_REPO: ${{ vars.GTMT_FRONT_IMAGE_REPO }}
          SPOTIFY_REDIRECT_RELATIVE_URI: ${{ vars.SPOTIFY_REDIRECT_RELATIVE_URI }}
          SPOTIFY_SCOPES: ${{ vars.SPOTIFY_SCOPES }}
          GOOGLE_REDIRECT_RELATIVE_URI: ${{ vars.GOOGLE_REDIRECT_RELATIVE_URI }}
          SERVER_DEPLOY_USERNAME: ${{ secrets.SERVER_DEPLOY_USERNAME }}
          SERVER_DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.SERVER_DEPLOY_SSH_PRIVATE_KEY }}
          SPOTIFY_CLIENT_ID_PROD: ${{ secrets.SPOTIFY_CLIENT_ID_PROD }}
          GOOGLE_CLIENT_ID_PROD: ${{ secrets.GOOGLE_CLIENT_ID_PROD }}
        run: |
          bash scripts/check-workflow-env.sh \
            DOMAIN_NAME WEBHOOK_DIR WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE DOCKER_COMPOSE_DIR_NAME \
            APP_NAME GTMT_FRONT_SERVICE_NAME GTMT_FRONT_PORT CONTACT_EMAIL HTMT_API_SUBDOMAIN_NAME \
            API_VERSION CONTAINER_NAME DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE DOCKERHUB_USERNAME \
            GTMT_FRONT_IMAGE_REPO SPOTIFY_REDIRECT_RELATIVE_URI SPOTIFY_SCOPES GOOGLE_REDIRECT_RELATIVE_URI \
            SERVER_DEPLOY_USERNAME SERVER_DEPLOY_SSH_PRIVATE_KEY SPOTIFY_CLIENT_ID_PROD GOOGLE_CLIENT_ID_PROD

      - name: Build compose env file
        run: |
          mkdir -p pool_compose
          {
            echo "NODE_ENV=${{ inputs.env }}"
            echo "APP_VERSION=${{ inputs.app_version }}"
            echo "NEXT_PUBLIC_APP_VERSION=${{ inputs.app_version }}"
            echo "APP_PORT=${{ vars.GTMT_FRONT_PORT }}"
            echo "NEXT_PUBLIC_CONTACT_EMAIL=${{ vars.CONTACT_EMAIL }}"
            echo "NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ vars.HTMT_API_SUBDOMAIN_NAME }}.${{ vars.DOMAIN_NAME }}/${{ vars.API_VERSION }}/"
            echo "NEXT_PUBLIC_SENTRY_IS_ACTIVE=${{ vars.SENTRY_IS_ACTIVE }}"
            echo "NEXT_PUBLIC_SPOTIFY_AUTH_URL=https://accounts.spotify.com/authorize"
            echo "NEXT_PUBLIC_SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID_PROD }}"
            echo "NEXT_PUBLIC_SPOTIFY_REDIRECT_URI=/${{ vars.SPOTIFY_REDIRECT_RELATIVE_URI }}"
            echo "NEXT_PUBLIC_SPOTIFY_SCOPES=${{ vars.SPOTIFY_SCOPES }}"
            echo "NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID_PROD }}"
            echo "NEXT_PUBLIC_GOOGLE_REDIRECT_URI=/${{ vars.GOOGLE_REDIRECT_RELATIVE_URI }}"
          } > pool_compose/${{ env.DOCKERIZED_APP_ENV_FILENAME }}

      - name: Generate partial docker compose file
        env:
          DOCKER_COMPOSE_PARTIAL_FILENAME: gtmt-front${{ vars.DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE }}
          SERVICE_NAME: ${{ vars.GTMT_FRONT_SERVICE_NAME }}
          PROJECT_DIR: ${{ env.CONTAINER_ROOT_DIR }}
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          IMAGE_REPO: ${{ vars.GTMT_FRONT_IMAGE_REPO }}
          APP_VERSION: ${{ inputs.app_version }}
          CONTAINER_NAME: ${{ vars.CONTAINER_NAME }}
          APP_PORT: ${{ vars.GTMT_FRONT_PORT }}
          ENV_FILENAME: ${{ env.DOCKERIZED_APP_ENV_FILENAME }}
        run: bash scripts/generate-partial-docker-compose.sh

      - name: Prepare compose-parts
        run: |
          mkdir -p compose_parts
          cp scripts/gtmt-front${{ vars.DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE }} compose_parts/

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.DOMAIN_NAME }} >> ~/.ssh/known_hosts

      - name: Deploy app env file
        env:
          POOL_DIR: ${{ vars.WEBHOOK_DIR }}${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE }}-${{ inputs.env }}/pool
        run: |
          ssh ${{ env.SSH_DESTINATION }} "mkdir -p $POOL_DIR/compose/${{ vars.APP_NAME }}"
          shopt -s dotglob && scp -r pool_compose/* ${{ env.SSH_DESTINATION }}:$POOL_DIR/compose/${{ vars.APP_NAME }}/

      - name: Deploy partial docker compose
        env:
          SERVER_DOCKER_COMPOSE_DIR: ${{ vars.WEBHOOK_DIR }}${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE }}-${{ inputs.env }}/${{ vars.DOCKER_COMPOSE_DIR_NAME }}/
        run: |
          shopt -s dotglob && scp -r compose_parts/* ${{ env.SSH_DESTINATION }}:$SERVER_DOCKER_COMPOSE_DIR
