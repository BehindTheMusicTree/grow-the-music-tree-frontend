# Flow: determine-version (+ env) → check-required-vars → [test-build-app | set-env-variables | set-docker-compose] → build-image-and-push → deploy
# Requires GitHub vars: WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE, DOCKER_COMPOSE_DIR_NAME, DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE, etc.
# See docs/github-vars-dual-env.md in server-management for var names.
name: Publish

on:
  push:
    tags:
      - "v*"
  workflow_call:

env:
  SSH_DESTINATION: ${{ secrets.SERVER_DEPLOY_USERNAME }}@${{ vars.DOMAIN_NAME }}
  CONTAINER_ROOT_DIR: /home/app/
  DOCKERIZED_APP_ENV_FILENAME: .env_gtmt_front
  DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
  WEBHOOK_DIR: ${{ vars.WEBHOOK_DIR }}
  WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE: ${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE }}
  DOCKER_COMPOSE_DIR_NAME: ${{ vars.DOCKER_COMPOSE_DIR_NAME }}
  DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
  GTMT_FRONT_IMAGE_REPO: ${{ vars.GTMT_FRONT_IMAGE_REPO }}
  GTMT_FRONT_PORT: ${{ vars.GTMT_FRONT_PORT }}
  GTMT_FRONT_SERVICE_NAME: ${{ vars.GTMT_FRONT_SERVICE_NAME }}
  CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
  HTMT_API_SUBDOMAIN_NAME: ${{ vars.HTMT_API_SUBDOMAIN_NAME }}
  API_VERSION: ${{ vars.API_VERSION }}
  CONTAINER_NAME: ${{ vars.CONTAINER_NAME }}
  DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE: ${{ vars.DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE }}
  SPOTIFY_CLIENT_ID_PROD: ${{ secrets.SPOTIFY_CLIENT_ID_PROD }}
  SPOTIFY_REDIRECT_RELATIVE_URI: ${{ vars.SPOTIFY_REDIRECT_RELATIVE_URI }}
  SPOTIFY_SCOPES: ${{ vars.SPOTIFY_SCOPES }}
  GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID_PROD }}
  GOOGLE_REDIRECT_RELATIVE_URI: ${{ vars.GOOGLE_REDIRECT_RELATIVE_URI }}
  SERVER_DEPLOY_USERNAME: ${{ secrets.SERVER_DEPLOY_USERNAME }}
  SERVER_DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.SERVER_DEPLOY_SSH_PRIVATE_KEY }}
  DOCKERHUB_ACCESS_TOKEN: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

jobs:
  determine-version:
    name: Determine version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      env: ${{ steps.version.outputs.env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "Using version from tag ref: $VERSION"
          else
            git fetch --tags --force
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$LATEST_TAG" ]; then
              echo "Error: Cannot determine version. No tag provided."
              exit 1
            fi
            VERSION="${LATEST_TAG#v}"
            echo "Using latest tag version: $VERSION (from tag: $LATEST_TAG)"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if [[ "$VERSION" == *-* ]]; then
            echo "env=test" >> "$GITHUB_OUTPUT"
            echo "Prerelease version -> env test"
          else
            echo "env=prod" >> "$GITHUB_OUTPUT"
            echo "Release version -> env prod"
          fi

  check-required-vars:
    name: Check required variables and secrets
    runs-on: ubuntu-latest
    timeout-minutes: 1
    environment:
      name: TEST
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required vars and secrets
        run: |
          bash scripts/check-required-vars.sh \
            VAR_DOMAIN_NAME "${{ env.DOMAIN_NAME }}" \
            VAR_WEBHOOK_DIR "${{ env.WEBHOOK_DIR }}" \
            VAR_WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE "${{ env.WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE }}" \
            VAR_DOCKER_COMPOSE_DIR_NAME "${{ env.DOCKER_COMPOSE_DIR_NAME }}" \
            VAR_DOCKERHUB_USERNAME "${{ env.DOCKERHUB_USERNAME }}" \
            VAR_GTMT_FRONT_IMAGE_REPO "${{ env.GTMT_FRONT_IMAGE_REPO }}" \
            VAR_GTMT_FRONT_PORT "${{ env.GTMT_FRONT_PORT }}" \
            VAR_GTMT_FRONT_SERVICE_NAME "${{ env.GTMT_FRONT_SERVICE_NAME }}" \
            VAR_CONTACT_EMAIL "${{ env.CONTACT_EMAIL }}" \
            VAR_HTMT_API_SUBDOMAIN_NAME "${{ env.HTMT_API_SUBDOMAIN_NAME }}" \
            VAR_API_VERSION "${{ env.API_VERSION }}" \
            VAR_SENTRY_IS_ACTIVE "${{ vars.SENTRY_IS_ACTIVE }}" \
            VAR_CONTAINER_NAME "${{ env.CONTAINER_NAME }}" \
            VAR_DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE "${{ env.DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE }}" \
            SECRET_SPOTIFY_CLIENT_ID "${{ env.SPOTIFY_CLIENT_ID_PROD }}" \
            VAR_SPOTIFY_REDIRECT_RELATIVE_URI "${{ env.SPOTIFY_REDIRECT_RELATIVE_URI }}" \
            VAR_SPOTIFY_SCOPES "${{ env.SPOTIFY_SCOPES }}" \
            VAR_GOOGLE_REDIRECT_RELATIVE_URI "${{ env.GOOGLE_REDIRECT_RELATIVE_URI }}" \
            SECRET_GOOGLE_CLIENT_ID "${{ env.GOOGLE_CLIENT_ID }}" \
            SECRET_SERVER_DEPLOY_USERNAME "${{ env.SERVER_DEPLOY_USERNAME }}" \
            SECRET_SERVER_DEPLOY_SSH_PRIVATE_KEY "${{ env.SERVER_DEPLOY_SSH_PRIVATE_KEY }}" \
            SECRET_DOCKERHUB_ACCESS_TOKEN "${{ env.DOCKERHUB_ACCESS_TOKEN }}"

  test-build-app:
    name: Test build app
    runs-on: ubuntu-latest
    needs: [determine-version]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        env:
          NEXT_PUBLIC_BACKEND_BASE_URL: https://api.example.com/
          NEXT_PUBLIC_CONTACT_EMAIL: ci@example.com
          NEXT_PUBLIC_SPOTIFY_CLIENT_ID: ci-placeholder
          NEXT_PUBLIC_SPOTIFY_SCOPES: ci-placeholder
          NEXT_PUBLIC_SPOTIFY_REDIRECT_URI: https://ci.example.com/auth/spotify/callback
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ci-placeholder.apps.googleusercontent.com
          NEXT_PUBLIC_GOOGLE_REDIRECT_URI: https://ci.example.com/auth/google/callback
          NEXT_PUBLIC_SENTRY_IS_ACTIVE: false
        run: npm run build

  set-env-variables:
    name: Set environment variables
    runs-on: ubuntu-latest
    needs: [check-required-vars, determine-version]
    environment:
      name: TEST
    env:
      DOCKER_COMPOSE_DIR: ${{ vars.WEBHOOK_DIR }}${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE }}-${{ needs.determine-version.outputs.env }}/${{ vars.DOCKER_COMPOSE_DIR_NAME }}/
    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SERVER_DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh &&
          ssh-keyscan -H ${{ env.DOMAIN_NAME }} >> ~/.ssh/known_hosts

      - name: Set GTMT front environment variables on server
        env:
          ENV_FILE: ${{ env.DOCKER_COMPOSE_DIR }}${{ env.DOCKERIZED_APP_ENV_FILENAME }}
        run: |
          ssh ${{ env.SSH_DESTINATION }} "
            rm -f ${{ env.ENV_FILE }} &&
            echo 'NODE_ENV=${{ needs.determine-version.outputs.env }}' >> ${{ env.ENV_FILE }} &&
            echo 'APP_VERSION=${{ needs.determine-version.outputs.version }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_APP_VERSION=${{ needs.determine-version.outputs.version }}' >> ${{ env.ENV_FILE }} &&
            echo 'APP_PORT=${{ env.GTMT_FRONT_PORT }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_CONTACT_EMAIL=${{ env.CONTACT_EMAIL }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ env.HTMT_API_SUBDOMAIN_NAME }}.${{ env.DOMAIN_NAME }}/${{ env.API_VERSION }}/' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SENTRY_IS_ACTIVE=${{ vars.SENTRY_IS_ACTIVE }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SPOTIFY_AUTH_URL=https://accounts.spotify.com/authorize' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SPOTIFY_CLIENT_ID=${{ env.SPOTIFY_CLIENT_ID_PROD }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SPOTIFY_REDIRECT_URI=/${{ env.SPOTIFY_REDIRECT_RELATIVE_URI }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SPOTIFY_SCOPES=${{ env.SPOTIFY_SCOPES }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ env.GOOGLE_CLIENT_ID }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_GOOGLE_REDIRECT_URI=/${{ env.GOOGLE_REDIRECT_RELATIVE_URI }}' >> ${{ env.ENV_FILE }}
          "

  set-docker-compose:
    name: Configure Docker Compose
    runs-on: ubuntu-latest
    needs: [check-required-vars, determine-version]
    environment:
      name: TEST
    env:
      DOCKER_COMPOSE_DIR: ${{ vars.WEBHOOK_DIR }}${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE }}-${{ needs.determine-version.outputs.env }}/${{ vars.DOCKER_COMPOSE_DIR_NAME }}/
      DOCKER_COMPOSE_PARTIAL_FILENAME: gtmt-front${{ vars.DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE }}
    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SERVER_DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh &&
          ssh-keyscan -H ${{ env.DOMAIN_NAME }} >> ~/.ssh/known_hosts

      - name: Generate partial docker compose file
        env:
          DOCKER_COMPOSE_PARTIAL_FILENAME: ${{ env.DOCKER_COMPOSE_PARTIAL_FILENAME }}
          SERVICE_NAME: ${{ env.GTMT_FRONT_SERVICE_NAME }}
          PROJECT_DIR: ${{ env.CONTAINER_ROOT_DIR }}
          DOCKERHUB_USERNAME: ${{ env.DOCKERHUB_USERNAME }}
          IMAGE_REPO: ${{ env.GTMT_FRONT_IMAGE_REPO }}
          APP_VERSION: ${{ needs.determine-version.outputs.version }}
          CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
          APP_PORT: ${{ env.GTMT_FRONT_PORT }}
          ENV_FILENAME: ${{ env.DOCKERIZED_APP_ENV_FILENAME }}
        run: bash scripts/generate-partial-docker-compose.sh

      - name: Transfer partial docker-compose to server
        env:
          DOCKER_COMPOSE_PARTIAL_FILE: ${{ env.DOCKER_COMPOSE_DIR }}${{ env.DOCKER_COMPOSE_PARTIAL_FILENAME }}
        run: scp scripts/${{ env.DOCKER_COMPOSE_PARTIAL_FILENAME }} ${{ env.SSH_DESTINATION }}:${{ env.DOCKER_COMPOSE_DIR }}

  build-image-and-push:
    name: Build & push Docker image
    runs-on: ubuntu-latest
    needs: [check-required-vars, determine-version, test-build-app]
    environment:
      name: TEST
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Dockerhub
        run: echo "${{ env.DOCKERHUB_ACCESS_TOKEN }}" | docker login -u "${{ env.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.DOCKERHUB_USERNAME }}/${{ env.GTMT_FRONT_IMAGE_REPO }}:${{ needs.determine-version.outputs.version }}
          build-args: |
            PROJECT_DIR=${{ env.CONTAINER_ROOT_DIR }}
            APP_PORT=${{ env.GTMT_FRONT_PORT }}

  call-redeployment-webhook:
    name: Deploy to server
    needs: [set-env-variables, set-docker-compose, build-image-and-push, determine-version]
    uses: BehindTheMusicTree/github-workflows/.github/workflows/call-redeployment-webhook.yml@main
    with:
      env: ${{ needs.determine-version.outputs.env }}
    secrets: inherit
