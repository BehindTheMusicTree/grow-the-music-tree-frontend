name: Publish

on:
  push:
    tags:
      - "*"
  workflow_call:

env:
  SSH_DESTINATION: ${{ secrets.SERVER_DEPLOY_USERNAME }}@${{ vars.DOMAIN_NAME }}
  DOCKER_COMPOSE_DIR: ${{ vars.WEBHOOK_DIR }}${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME }}/${{ vars.DOCKER_COMPOSE_DIR_NAME }}/
  CONTAINER_ROOT_DIR: /home/app/
  DOCKERIZED_APP_ENV_FILENAME: .env_gtmt_front
  BUILD_COMPLETE_FILENAME: build-complete.txt

jobs:
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract from tag ref (e.g., refs/tags/v0.3.4 -> 0.3.4)
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "Using version from tag ref: $VERSION"
          else
            # Fallback: fetch tags and get the latest one
            git fetch --tags --force
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$LATEST_TAG" ]; then
              echo "Error: Cannot determine version. No tag provided."
              exit 1
            fi
            # Remove 'v' prefix if present
            VERSION="${LATEST_TAG#v}"
            echo "Using latest tag version: $VERSION (from tag: $LATEST_TAG)"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [determine-version]
    environment:
      name: TEST
    steps:
      - name: Check required vars and secrets
        env:
          VAR_DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          VAR_WEBHOOK_DIR: ${{ vars.WEBHOOK_DIR }}
          VAR_WEBHOOK_REDEPLOYMENT_DIR_NAME: ${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME }}
          VAR_DOCKER_COMPOSE_DIR_NAME: ${{ vars.DOCKER_COMPOSE_DIR_NAME }}
          VAR_DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          VAR_GTMT_FRONT_IMAGE_REPO: ${{ vars.GTMT_FRONT_IMAGE_REPO }}
          VAR_GTMT_FRONT_PORT: ${{ vars.GTMT_FRONT_PORT }}
          VAR_GTMT_FRONT_SERVICE_NAME: ${{ vars.GTMT_FRONT_SERVICE_NAME }}
          VAR_CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
          VAR_API_VERSION: ${{ vars.API_VERSION }}
          VAR_SENTRY_IS_ACTIVE: ${{ vars.SENTRY_IS_ACTIVE }}
          VAR_CONTAINER_NAME: ${{ vars.CONTAINER_NAME }}
          VAR_DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE: ${{ vars.DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE }}
          SECRET_SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SECRET_SERVER_DEPLOY_USERNAME: ${{ secrets.SERVER_DEPLOY_USERNAME }}
          SECRET_SERVER_DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.SERVER_DEPLOY_SSH_PRIVATE_KEY }}
          SECRET_DOCKERHUB_ACCESS_TOKEN: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}
        run: |
          missing=""
          [ -z "$VAR_DOMAIN_NAME" ] && missing="$missing DOMAIN_NAME"
          [ -z "$VAR_WEBHOOK_DIR" ] && missing="$missing WEBHOOK_DIR"
          [ -z "$VAR_WEBHOOK_REDEPLOYMENT_DIR_NAME" ] && missing="$missing WEBHOOK_REDEPLOYMENT_DIR_NAME"
          [ -z "$VAR_DOCKER_COMPOSE_DIR_NAME" ] && missing="$missing DOCKER_COMPOSE_DIR_NAME"
          [ -z "$VAR_DOCKERHUB_USERNAME" ] && missing="$missing DOCKERHUB_USERNAME"
          [ -z "$VAR_GTMT_FRONT_IMAGE_REPO" ] && missing="$missing GTMT_FRONT_IMAGE_REPO"
          [ -z "$VAR_GTMT_FRONT_PORT" ] && missing="$missing GTMT_FRONT_PORT"
          [ -z "$VAR_GTMT_FRONT_SERVICE_NAME" ] && missing="$missing GTMT_FRONT_SERVICE_NAME"
          [ -z "$VAR_CONTACT_EMAIL" ] && missing="$missing CONTACT_EMAIL"
          [ -z "$VAR_API_VERSION" ] && missing="$missing API_VERSION"
          [ -z "$VAR_SENTRY_IS_ACTIVE" ] && missing="$missing SENTRY_IS_ACTIVE"
          [ -z "$VAR_CONTAINER_NAME" ] && missing="$missing CONTAINER_NAME"
          [ -z "$VAR_DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE" ] && missing="$missing DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE"
          [ -z "$SECRET_SPOTIFY_CLIENT_ID" ] && missing="$missing SPOTIFY_CLIENT_ID"
          [ -z "$SECRET_SERVER_DEPLOY_USERNAME" ] && missing="$missing SERVER_DEPLOY_USERNAME"
          [ -z "$SECRET_SERVER_DEPLOY_SSH_PRIVATE_KEY" ] && missing="$missing SERVER_DEPLOY_SSH_PRIVATE_KEY"
          [ -z "$SECRET_DOCKERHUB_ACCESS_TOKEN" ] && missing="$missing DOCKERHUB_ACCESS_TOKEN"
          if [ -n "$missing" ]; then
            echo "Missing vars or secrets:$missing"
            exit 1
          fi
          echo "All required vars and secrets are set."

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Dockerhub
        run: echo "${{ secrets.DOCKERHUB_ACCESS_TOKEN }}" | docker login -u "${{ vars.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.GTMT_FRONT_IMAGE_REPO }}:${{ needs.determine-version.outputs.version }}
          build-args: |
            PROJECT_DIR=${{ env.CONTAINER_ROOT_DIR }}
            APP_PORT=${{ vars.GTMT_FRONT_PORT }}
            BUILD_COMPLETE_FILENAME=${{ env.BUILD_COMPLETE_FILENAME }}

  set-env-variables:
    name: Set Environment Variables
    runs-on: ubuntu-latest
    needs: [build-and-push]
    environment:
      name: TEST
    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh &&
          ssh-keyscan -H ${{ vars.DOMAIN_NAME }} >> ~/.ssh/known_hosts

      - name: Set GTMT front environment variables on server
        env:
          ENV_FILE: ${{ env.DOCKER_COMPOSE_DIR }}${{ env.DOCKERIZED_APP_ENV_FILENAME }}
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
        run: |
          ssh ${{ env.SSH_DESTINATION }} "
            rm -f ${{ env.ENV_FILE }} &&
            echo 'NODE_ENV=test' >> $ENV_FILE &&
            echo 'APP_PORT=${{ vars.GTMT_FRONT_PORT }}' >> ${{ env.ENV_FILE }} &&
            echo 'BUILD_COMPLETE_FILENAME=${{ env.BUILD_COMPLETE_FILENAME }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_CONTACT_EMAIL=${{ vars.CONTACT_EMAIL }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ vars.DOMAIN_NAME }}/${{ vars.API_VERSION }}/' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SENTRY_IS_ACTIVE=${{ vars.SENTRY_IS_ACTIVE }}' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SPOTIFY_AUTH_URL=https://accounts.spotify.com/authorize' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SPOTIFY_CLIENT_ID=$SPOTIFY_CLIENT_ID' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SPOTIFY_REDIRECT_URI=/auth/spotify/callback' >> ${{ env.ENV_FILE }} &&
            echo 'NEXT_PUBLIC_SPOTIFY_SCOPES=user-read-email playlist-read-private playlist-read-collaborative user-library-read user-top-read' >> ${{ env.ENV_FILE }}
          "

  set-docker-compose:
    name: Configure Docker Compose
    runs-on: ubuntu-latest
    needs: [determine-version, build-and-push]
    environment:
      name: TEST
    env:
      DOCKER_COMPOSE_PARTIAL_FILENAME: gtmt-front${{ vars.DOCKER_COMPOSE_PARTIAL_FILENAME_SUFFIXE }}
    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh &&
          ssh-keyscan -H ${{ vars.DOMAIN_NAME }} >> ~/.ssh/known_hosts

      - name: Debug version output
        run: |
          echo "Version from determine-version job: ${{ needs.determine-version.outputs.version }}"

      - name: Generate partial docker compose file
        env:
          DOCKER_COMPOSE_PARTIAL_FILENAME: ${{ env.DOCKER_COMPOSE_PARTIAL_FILENAME }}
          SERVICE_NAME: ${{ vars.GTMT_FRONT_SERVICE_NAME }}
          PROJECT_DIR: ${{ env.CONTAINER_ROOT_DIR }}
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          IMAGE_REPO: ${{ vars.GTMT_FRONT_IMAGE_REPO }}
          APP_VERSION: ${{ needs.determine-version.outputs.version }}
          CONTAINER_NAME: ${{ vars.CONTAINER_NAME }}
          APP_PORT: ${{ vars.GTMT_FRONT_PORT }}
          ENV_FILENAME: ${{ env.DOCKERIZED_APP_ENV_FILENAME }}
          BUILD_COMPLETE_FILENAME: ${{ env.BUILD_COMPLETE_FILENAME }}
        run: bash scripts/generate-partial-docker-compose.sh

      - name: Transfer partial docker-compose to server
        env:
          DOCKER_COMPOSE_PARTIAL_FILE: ${{ env.DOCKER_COMPOSE_DIR }}${{ env.DOCKER_COMPOSE_PARTIAL_FILENAME }}
        run: scp scripts/${{ env.DOCKER_COMPOSE_PARTIAL_FILENAME }} ${{ env.SSH_DESTINATION }}:${{ env.DOCKER_COMPOSE_DIR }}

  deploy:
    name: Deploy to Server
    needs: [set-env-variables, set-docker-compose]
    uses: BehindTheMusicTree/github-workflows/.github/workflows/call-redeployment-webhook.yml@main
    with:
      env: TEST
    secrets: inherit
